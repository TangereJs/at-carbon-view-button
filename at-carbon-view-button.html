<link rel="import" href="../tangere/tangere.html" />
<link rel="import" href="../at-theme/at-theme.html" />

<link rel="import" href="../at-carbon-icon-button/at-carbon-icon-button.html" />
<link rel="import" href="../at-core-dropdown/at-core-dropdown.html" />
<link rel="import" href="../at-core-view/at-core-view.html" />

<dom-module id="at-carbon-view-button">
  <template>
    <style>
       :host {
        display: block;
        box-sizing: border-box;
        position: relative;
        min-height: 40px;
      }

      .absolute-container {
        position: absolute;
      }
    </style>

    <div class="absolute-container">
      <at-carbon-icon-button id="dropdownTrigger" disabled$="[[disabled]]" hidden$="[[toggleOnly]]" icon="[[icon]]" color="[[color]]" on-tap="_toggleDropdown"></at-carbon-icon-button>
      <at-core-dropdown id="dropdown" position="[[position]]" x-offset="[[xOffset]]" y-offset="[[yOffset]]" on-open-changed="_handleDropdownOpenChanged"></at-core-dropdown>
    </div>

  </template>
</dom-module>
<script>
  Polymer({
    is: "at-carbon-view-button",
    properties: {

      disabled: {
        type: Boolean,
        value: false
      },

      icon: {
        type: String,
        title: "Icon",
        value: "now:menu"
      },

      color: {
        type: String,
        value: ""
      },

      position: {
        type: String,
        value: "bottomLeft",
        xtype: "enum",
        xvaluelist: [{
          title: "Top Left",
          value: "topLeft"
        }, {
          title: "Top Right",
          value: "topRight"
        }, {
          title: "Bottom Left",
          value: "bottomLeft"
        }, {
          title: "Bottom Right",
          value: "bottomRight"
        }]
      },

      xOffset: {
        type: Number,
        value: 0
      },

      yOffset: {
        type: Number,
        value: 0
      },

      model: {
        type: Object,
        value: null
      },

      modelRoot: {
        type: String,
        value: ""
      },

      value: {
        type: Object,
        value: null,
        xgridcols: "12",
        xtype: 'json'
      },

      view: {
        type: String,
        value: null,
        xtype: 'code',
        xgridcols: "12",
        mode: "carbon"
      },

      placeholder: {
        type: String,
        value: "<div class='m'> <div class='placeholder-text'></div><div class='placeholder-text mtsm'></div><div class='placeholder-text mtsm'></div></div>",
        xtype: 'code',
        xgridcols: "12",
        mode: "html"
      },

      toggleOnly: {
        type: Boolean,
        value: false
      }
    },

    $meta: [{
      title: "View Button",
      type: "element",
      xtype: "at-carbon-view-button",
      icon: "now:wrench"
    }],

    ready: function() {

    },

    toggle: function(relativeTo) {
      if (!this.toggleOnly) return;
      
      // we can not use this.$.dropdownTrigger with toggleOnly = true
      // because this.$.dropdownTrigger.getBoundingClientRect() is filled with zeros
      // left, top, width, height are all zero
      this._handleDropdownToggle(relativeTo);
    },

    _toggleDropdown: function(event) {
      this._handleDropdownToggle(this.$.dropdownTrigger);
    },

    _handleDropdownToggle: function(relativeTo) {
      if (this.$.dropdown.open) {
        this.$.dropdown.hide();
        return;
      }
      
      var self = this;

      var coreView = this.__coreView = document.createElement('at-core-view');
      Polymer.dom(this.$.dropdown).appendChild(coreView);
        
      coreView.addEventListener('content-changed', function() {
        self.$.dropdown.toggle(relativeTo);
        
        self.$.dropdown.updateContainerAndOutlineSize();
      });
      
      coreView.model = this.model;
      coreView.modelRoot = this.modelRoot;
      coreView.value = this.value;
      coreView.placeholder = this.placeholder;
      coreView.view = this.view;

      this.async(function() {
        self.$.dropdown._returnImplToDocumentBody();
      });
    },

    _handleDropdownOpenChanged: function(event) {
      if (event.detail.value) return;
      if (!this.__coreView) return; 
      Polymer.dom(this.$.dropdown).removeChild(this.__coreView);   
    }
  });
</script>
